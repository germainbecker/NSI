<h1 id="sql-avec-python">SQL avec Python</h1>
<img class="centre image-responsive" src="data/python_sql.svg" width="700" alt="illustration">
<p>On présente dans ce tutoriel comment utiliser le langage Python, via le module <code>sqlite3</code>, pour interagir avec une base de données SQLite. Cela vous permettra d’apprendre à utiliser une base de données dans vos futurs projets.</p>
<p>La vidéo associée est la suivante :</p>
<div class="video-responsive">
    <iframe class="centre" width="560" height="315" src="https://www.youtube-nocookie.com/embed/JiEoZ8Z9oUQ" title="YouTube video player" allowfullscreen=""></iframe>
</div>
<p class="impression">
Source : <a href="https://youtu.be/JiEoZ8Z9oUQ">https://youtu.be/JiEoZ8Z9oUQ</a>
</p>
<h1 id="création-et-connexion-avec-la-base-de-données">Création et connexion avec la base de données</h1>
<p>Premièrement, on doit créer une nouvelle base de données et s’y connecté pour permettre au module <code>sqlite3</code> d’intéragir avec elle.</p>
<p>On utilise <code>sqlite3.connect()</code> pour créer la connexion avec la base de données <code>eleves.db</code> dans le répertoire courant, cette base étant créée si elle n’existe pas.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> sqlite3
conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'eleves.db'</span><span class="token punctuation">)</span>
</code></pre>
<p>L’objet <code>conn</code> représente la connexion avec la base de données sur le disque.</p>
<p>Une fois la connexion établie, il est nécessaire de créer un <em>curseur</em> grâce à <code>conn.cursor()</code> (c’est un objet de la classe <code>Cursor</code>).</p>
<pre class=" language-python"><code class="prism  language-python">cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Maintenant que nous avons la connexion et un curseur on peut exécuter des requêtes SQL et récupérer les résultats grâce au curseur.</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""CREATE TABLE Eleve (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nom TEXT,
    prenom TEXT,
    age INTEGER,
    classe TEXT);
    """</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Remarques</strong> :</p>
<ul>
<li>On peut utiliser des triples guillemets pour écrire les chaînes de requêtes sur plusieurs lignes et mieux les formater visuellement.</li>
<li>SQLite ne prévoit que 5 domaines pour les attributs d’une table : <code>NULL</code>, <code>INTEGER</code>, <code>REAL</code>, <code>TEXT</code>, <code>BLOB</code>. Voir ce lien pour plus de détails : <a href="https://www.sqlite.org/datatype3.html">https://www.sqlite.org/datatype3.html</a></li>
<li>On a utilisé <code>AUTOINCREMENT</code> pour ne plus avoir besoin de spécifier l’<code>id</code> comme clé primaire : celle-ci s’autoincrémente à chaque nouvel enregistrement dans la base. C’est très utile car la plupart du temps on ne sait pas quelle clé primaire utiliser pour ajouter un nouvel enregistrement.</li>
</ul>
<p>Une fois la requête exécutée, il ne faut pas oublier de stopper la connexion avec la base de données. On utilise pour cela la méthode <code>close</code> :</p>
<pre class=" language-python"><code class="prism  language-python">conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>On peut créer une fonction qui permet de créer notre table, en la supprimant si elle existe déjà (pour mieux faire nos essais) :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">creer_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'eleves.db'</span><span class="token punctuation">)</span>
    cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS Eleve;"</span><span class="token punctuation">)</span>
    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""CREATE TABLE Eleve (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nom TEXT,
        prenom TEXT,
        age INTEGER,
        classe TEXT);
        """</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="insérer-des-enregistrements">Insérer des enregistrements</h1>
<p>Pour insérer des enregistrements, on utilise notre curseur pour exécuter des requêtes SQL.</p>
<h2 id="insérer-un-enregistrement">Insérer un enregistrement</h2>
<p>Si on souhaite insérer un élève dans la table <code>Eleve</code> on appelle la méthode <code>cur.execute()</code> en lui passant en paramètre une chaîne de caractères correspondant à une requête SQL :</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO Eleve (id, nom, prenom, age, classe) VALUES (1, 'Dupont', 'Jean', 15, '2A')"</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<blockquote>
<p><span>⚠️</span> L’instruction <code>INSERT</code> crée ce qu’on appelle une <em>transaction</em>, qui doit être validée par <code>conn.commit()</code> afin que les changements soient enregistrés en base de données !</p>
</blockquote>
<p>Dans le cas précédent, on les données à insérer étaient directement écrites dans la chaîne de requête. Or, bien souvent les données que l’on veut utiliser dans une requête sont stockées dans des variables et on peut utiliser ces variables pour construire la chaîne de requête. On appelle cela une <strong>requête préparée</strong>, qui fait appel au caractère <code>?</code> de la façon suivante :</p>
<pre class=" language-python"><code class="prism  language-python">eleve_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span>
cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO Eleve (nom, prenom, age, classe) VALUES (?, ?, ?, ?)"</span><span class="token punctuation">,</span> eleve_2<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>On passe un <code>tuple</code> en deuxième paramètre à notre méthode <code>execute</code> : ce tuple contient les valeurs par lesquelles SQLite doit remplacer les <code>?</code>.</p>
<blockquote>
<p>Cette manière de faire permet de se prémunir d’une faille de sécurité appelée <strong>injection SQL</strong> dont nous reparlerons par la suite.</p>
</blockquote>
<p>Il est également possible de construire une requête à partir de données mémorisées dans un dictionnaire. Ainsi, on peut insérer un troisième élève de cette façon :</p>
<pre class=" language-python"><code class="prism  language-python">eleve_3 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'nom'</span><span class="token punctuation">:</span> <span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'prenom'</span><span class="token punctuation">:</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'classe'</span><span class="token punctuation">:</span> <span class="token string">'2A'</span><span class="token punctuation">}</span>
cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""INSERT INTO Eleve (nom, prenom, age, classe) VALUES (:nom, :prenom, :age, :classe)"""</span><span class="token punctuation">,</span> eleve_3<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>De cette façon, SQLite va remplacer <code>:nom</code>, <code>:prenom</code>, <code>:age</code> et <code>:classe</code> dans la chaîne de requête par les valeurs associées aux clés <code>'nom'</code>, <code>'prenom'</code>, <code>'age'</code> et <code>'classe'</code> du dictionnaire passé en deuxième argument.</p>
<p>L’utilisation des clés des dictionnaires a l’avantage d’être plus explicite et de ne plus se soucier de l’ordre des données (comme pour un tuple par exemple)</p>
<h2 id="insérer-plusieurs-enregistrements">Insérer plusieurs enregistrements</h2>
<p>Si on dispose de données sur plusieurs élèves, on peut utiliser une boucle <code>for</code> en construisant la chaîne de requête SQL pour chaque élève de la façon suivante :</p>
<pre class=" language-python"><code class="prism  language-python">autres_eleves <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Lucas'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Rouger'</span><span class="token punctuation">,</span> <span class="token string">'Marius'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Louapre'</span><span class="token punctuation">,</span> <span class="token string">'Lola'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Boudou'</span><span class="token punctuation">,</span> <span class="token string">'Lise'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Aurélien'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Laurent'</span><span class="token punctuation">,</span> <span class="token string">'Diego'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Anaëlle'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'TG1'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token keyword">for</span> eleve <span class="token keyword">in</span> liste_eleves<span class="token punctuation">:</span>
    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO Eleve (nom, prenom, age, classe) VALUES (?, ?, ?, ?)"</span><span class="token punctuation">,</span> eleve<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>En réalité, le code précédent peut se raccourcir en utilisant la méthode <code>cur.executemany()</code> qui permet justement d’insérer plusieurs lignes en base de données directement. On préférera donc écrire le code équivalent qui suit :</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>executemany<span class="token punctuation">(</span><span class="token string">"INSERT INTO Eleve (nom, prenom, age, classe) VALUES (?, ?, ?, ?)"</span><span class="token punctuation">,</span> autres_eleves<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Il suffit de passer en deuxième paramètre à cette méthode une liste de séquences d’éléments (ici une liste de tuples).</p>
<blockquote>
<p>On peut aussi passer une liste de dictionnaires en deuxième paramètre, en prenant soin de remplacer les <code>?</code> de la requête par des <code>:cle</code> où <code>cle</code> désigne une clé du dictionnaire (syntaxe vue plus haut).</p>
</blockquote>
<h1 id="récupérer-des-données">Récupérer des données</h1>
<h2 id="les-méthodes-fetchall-fetchone-et-fetchmany">Les méthodes <code>fetchall</code>, <code>fetchone</code> et <code>fetchmany</code></h2>
<p>On peut exécuter des requêtes d’interrogation de la base de données. On utilise pour cela également la méthode <code>cur.execute()</code>. On peut affecter le résultat de la requête dans une variable <code>res</code>, qui est alors un itérable que l’on peut utiliser pour afficher les résultats.</p>
<p>Pour renvoyer tous les résultats, on applique la méthode <code>fetchall()</code> à <code>res</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM Eleve"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jean'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Lucas'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Rouger'</span><span class="token punctuation">,</span> <span class="token string">'Marius'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Louapre'</span><span class="token punctuation">,</span> <span class="token string">'Lola'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'Boudou'</span><span class="token punctuation">,</span> <span class="token string">'Lise'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Aurélien'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'Laurent'</span><span class="token punctuation">,</span> <span class="token string">'Diego'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p>Vous remarquerez que la méthode <code>fetchall</code> renvoie une liste de tuples. À ce titre on peut aussi simplement convertir l’itérable <code>res</code> en une liste :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM Eleve"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jean'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Lucas'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Rouger'</span><span class="token punctuation">,</span> <span class="token string">'Marius'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Louapre'</span><span class="token punctuation">,</span> <span class="token string">'Lola'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'Boudou'</span><span class="token punctuation">,</span> <span class="token string">'Lise'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Aurélien'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'Laurent'</span><span class="token punctuation">,</span> <span class="token string">'Diego'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p>Pour renvoyer un résultat, on applique la méthode <code>fetchone()</code> à <code>res</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM Eleve"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jean'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span>
</code></pre>
<p>La méthode <code>fetchone</code> renvoie en réalité la prochaine ligne du résultat de la requête. Par exemple, si on rappelle à nouveau la méthode <code>fetchone</code>, elle renvoie le deuxième élève :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span>
</code></pre>
<p>Pour choisir le nombre de résultats à renvoyer, on applique la méthode <code>fetchmany()</code> à <code>res</code> en lui passant en paramètre le nombre souhaité :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM Eleve"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jean'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'TG2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Lucas'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<blockquote>
<p>Pour les requêtes d’interrogation, il est inutile d’utiliser <code>conn.commit()</code> puisque ces requêtes n’entraînent aucun changement de la base de données.</p>
</blockquote>
<h2 id="requêtes-avec-paramètres">Requêtes avec paramètres</h2>
<p>On peut bien sûr construire des requêtes d’interrogation avec des paramètres. Pour cela il faut écrire une <strong>requête préparée</strong> comme vu précédemment. Par exemple, si on veut récupérer tous les élèves ayant pour nom <code>Dupont</code>, on écrira :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT id, nom, prenom FROM Eleve WHERE nom = ?"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Dupont'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> res<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jean'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Jeanne'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Lucas'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Aurélien'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p><strong>Remarques</strong></p>
<ul>
<li><span>⚠️</span> Vous noterez que l’on a écrit <code>('Dupont',)</code> en deuxième paramètre pour bien passer un tuple à la méthode <code>execute</code> (et non <code>('Dupont')</code> qui n’en serait pas un).</li>
<li>on aurait aussi pu utiliser la syntaxe avec les dictionnaires : <code>cur.execute("SELECT id, nom, prenom FROM Eleve WHERE nom = :nom", {'nom': 'Dupont'})</code></li>
</ul>
<p>Imaginons que notre application possède un champ permettant à l’utilisateur de saisir un nom pour chercher un élève dans la base de données, on peut créer une fonction qui serait appelée lorsque la saisie est validée.</p>
<p>En effet, on peut facilement écrire une telle fonction qui renvoie la liste de tous les élèves dont le nom lui est passé en paramètre. Cela ressemble à quelque chose comme ci-dessous :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">recuperer_eleves_par_nom</span><span class="token punctuation">(</span>nom<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'eleves.db'</span><span class="token punctuation">)</span>
    cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT id, nom, prenom FROM Eleve WHERE nom = ?"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>nom<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    eleves <span class="token operator">=</span> res<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># on stocke les résultats pour pouvoir les renvoyer</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> eleves  <span class="token comment"># après avoir fermé la connexion</span>
</code></pre>
<p>On peut bien sûr appeler cette fonction :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleves_par_nom<span class="token punctuation">(</span><span class="token string">'Martin'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Anaëlle'</span><span class="token punctuation">,</span> <span class="token string">'TG1'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleves_par_nom<span class="token punctuation">(</span><span class="token string">'Richard'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleves_par_nom<span class="token punctuation">(</span><span class="token string">'Obama'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre>
<h1 id="éviter-linjection-sql">Éviter l’injection SQL</h1>
<p>On a vu que l’on pouvait écrire des requêtes paramétrées grâce au caractère <code>?</code> (ou en utilisant des dictionnaires), et c’est vraiment ainsi qu’il faut procéder !</p>
<p>Ce n’est pas évident de prime abord, mais à la place d’écrire</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT id, nom, prenom FROM Eleve WHERE nom = ?"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>nom<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>on pourrait être tenté de construire la chaîne de requête de la façon suivante :</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT id, nom, prenom FROM Eleve WHERE nom = '"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nom<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
</code></pre>
<p>ou de manière équivalente en utilisant une <code>f-string</code> :</p>
<pre class=" language-python"><code class="prism  language-python">cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>f<span class="token string">"SELECT id, nom, prenom FROM Eleve WHERE nom = '{nom}'"</span><span class="token punctuation">)</span>
</code></pre>
<p>Ces deux dernières façons de faire, en construisant notre requête SQL comme une chaîne de caractères classique, introduisent en réalité une <strong>faille de sécurité</strong> critique pour notre application, qui devient vulnérable à ce qu’on appelle une <strong>injection SQL</strong>.</p>
<p>Nous expliquerons cela dans un second tutoriel, pour mettre en garde le développeur des conséquences désastreuses d’une telle faille de sécurité 👮‍♀️🥵👮 …</p>
<h1 id="✍️-à-vous-de-jouer-">✍️ À vous de jouer !</h1>
<h2 id="💻-exercice-1--application-directe">💻 Exercice 1 : Application directe</h2>
<p>🐍 <strong>Q1</strong> : Écrire une fonction <code>recuperer_eleves_par_classe</code> qui prend un paramètre <code>classe</code> et qui renvoie la liste de tous les élèves de la table <code>Eleve</code> qui sont dans la classe <code>classe</code>.</p>
<p><em>Exemple</em> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleves_par_classe<span class="token punctuation">(</span><span class="token string">'1G1'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Martin'</span><span class="token punctuation">,</span> <span class="token string">'Adeline'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Dupont'</span><span class="token punctuation">,</span> <span class="token string">'Aurélien'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G1'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p>🐍 <strong>Q2</strong> : Écrire une fonction <code>recuperer_eleve</code> qui prend un entier <code>id_eleve</code> en paramètre et qui renvoie l’élève (les attributs nom, prenom, classe uniquement) ayant pour identifiant <code>id_eleve</code>.</p>
<p><em>Exemple</em> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleve<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token string">'2A'</span><span class="token punctuation">)</span>
</code></pre>
<p>🐍 <strong>Q3</strong> : Écrire une fonction <code>changer_classe</code> qui prend en paramètre un entier <code>id_eleve</code> correspondant à l’attribut <code>id</code> d’un élève, et une chaîne de caractère <code>nouvelle_classe</code> et qui modifie la classe de l’élève en question en base de données.</p>
<p><em>Exemple</em> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> changer_classe<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'2C'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_eleve<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'Marchand'</span><span class="token punctuation">,</span> <span class="token string">'Marie'</span><span class="token punctuation">,</span> <span class="token string">'2C'</span><span class="token punctuation">)</span>
</code></pre>
<p>🐍 <strong>Q4</strong> : Écrire une fonction <code>recuperer_liste_alphabetique_par_classe</code> qui prend un paramètre <code>classe</code> et qui renvoie la liste <em>triée par ordre alphabétique</em> de tous les élèves de la table <code>Eleve</code> qui sont dans la classe <code>classe</code>. <em>Le tri doit d’être réalisé par la requête SQL (vous pourrez ensuite le réaliser avec Python en triant la liste des résultats)</em>.</p>
<p><em>Exemple</em> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> recuperer_liste_alphabetique_par_classe<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Laurent'</span><span class="token punctuation">,</span> <span class="token string">'Diego'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Richard'</span><span class="token punctuation">,</span> <span class="token string">'Louise'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Rouger'</span><span class="token punctuation">,</span> <span class="token string">'Marius'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'1G2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<h2 id="💻-exercice-2--créer-et-utiliser-une-classe-eleve">💻 Exercice 2 : Créer et utiliser une classe <code>Eleve</code></h2>
<p>🐍  <strong>Q1</strong> : Écrire une classe Python appelée <code>Eleve</code> dont les instances possèdent 4 attributs : 3 <code>nom</code> (de type <code>str</code>), <code>prenom</code> (de type <code>str</code>), <code>age</code> (de type <code>int</code>) et <code>classe</code> (de type <code>str</code>).</p>
<p>🐍 <strong>Q2</strong> : Quelle instruction permet de créer un objet de la classe <code>Eleve</code> vous correspondant ?</p>
<p>🐍 <strong>Q3</strong> : Écrivez une fonction <code>ajouter_eleve(eleve)</code> qui prend en paramètre <strong>un objet</strong> <code>eleve</code> de la classe <code>Eleve</code> et qui ajoute cet élève en base de données.</p>
<p>🐍 <strong>Q4</strong> : Utilisez cette fonction pour ajouter l’élève créé à la question 2 en base de données puis vérifiez que l’ajout a bien été réalisé.</p>
<hr>
<p><strong>Références</strong> :</p>
<ul>
<li>Documentation officielle du module <code>sqlite</code> : <a href="https://docs.python.org/3/library/sqlite3.html">https://docs.python.org/3/library/sqlite3.html</a></li>
<li>Vidéo de Corey Schafer, <em>Python SQLite Tutorial: Complete Overview - Creating a Database, Table, and Running Queries</em> : <a href="https://youtu.be/pd-0G0MigUA">https://youtu.be/pd-0G0MigUA</a></li>
</ul>
<hr>
<p>Germain BECKER, Lycée Emmanuel Mounier, ANGERS</p>
<p><img src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="Licence Creative Commons"></p>

